<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>库区地图</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        emma: {
                            500: '#ec4899', 
                            600: '#db2777',
                            700: '#be185d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        .aisle-track { overflow-x: auto; white-space: nowrap; scrollbar-width: thin; }
        .popover-enter-active {
            opacity: 1 !important;
            transform: scale(1) !important;
            transition: opacity 0.2s, transform 0.2s;
        }
    </style>
</head>
<body class="bg-slate-100 p-6 h-screen flex flex-col">
    <div class="bg-white p-6 rounded-xl shadow-sm h-full flex flex-col border border-slate-200">
        <div class="flex justify-between items-center mb-4 flex-shrink-0">
            <h2 class="text-xl font-bold text-slate-800">库区实时监控地图</h2>
            <div class="flex gap-4 text-sm">
                <span class="flex items-center gap-2"><span class="w-3 h-3 bg-blue-100 border border-blue-500 rounded"></span> 入库中</span>
                <span class="flex items-center gap-2"><span class="w-3 h-3 bg-green-100 border border-green-500 rounded"></span> 在库</span>
                <span class="flex items-center gap-2"><span class="w-3 h-3 bg-purple-100 border border-purple-500 rounded"></span> 出库中</span>
            </div>
        </div>
        
        <!-- Map Container -->
        <div id="warehouse-map-container" class="flex-1 overflow-y-auto pr-2 space-y-6">
            <!-- Content generated by JS -->
        </div>
    </div>

    <!-- Floating Tooltip (Hidden by default) -->
    <div id="car-tooltip" class="fixed z-50 bg-slate-800 text-white text-sm rounded-lg shadow-xl p-4 hidden pointer-events-none transition-opacity duration-200 opacity-0 w-64">
        <div class="flex justify-between items-center mb-2 border-b border-slate-600 pb-1">
            <span class="font-bold text-pink-500"><i class="fa-solid fa-dolly"></i> <span id="tip-car-code">C-10001</span></span>
            <span id="tip-status" class="text-xs bg-green-600 px-1.5 py-0.5 rounded">在库</span>
        </div>
        <div class="space-y-1">
            <div class="flex justify-between"><span class="text-slate-400">物料名称:</span> <span id="tip-name" class="font-medium text-right">简易款车架</span></div>
            <div class="flex justify-between"><span class="text-slate-400">物料编码:</span> <span id="tip-mat-code" class="font-mono text-right">M-001</span></div>
            <div class="flex justify-between"><span class="text-slate-400">数量:</span> <span id="tip-qty" class="font-bold text-right">6</span></div>
            <div class="flex justify-between"><span class="text-slate-400">入库时间:</span> <span id="tip-inbound-time" class="text-right text-xs">2026-01-27 10:30:00</span></div>
        </div>
    </div>

    <script>
        // --- Warehouse Map Logic ---
        const zonesConfig = [
            { id: 0, name: "空挂具库区", aisles: 3, capacity: 300 },
            { id: 1, name: "库区 1", aisles: 5, capacity: 500 },
            { id: 2, name: "库区 2", aisles: 5, capacity: 500 },
            { id: 3, name: "库区 3", aisles: 5, capacity: 500 },
            { id: 4, name: "库区 4", aisles: 5, capacity: 500 },
            { id: 5, name: "库区 5", aisles: 5, capacity: 500 },
            { id: 6, name: "库区 6", aisles: 5, capacity: 500 },
            { id: 7, name: "库区 7", aisles: 5, capacity: 500 },
            { id: 8, name: "库区 8", aisles: 5, capacity: 500 },
            { id: 9, name: "库区 9", aisles: 5, capacity: 500 },
        ];

        function getMockCar(zoneId, aisleIdx, posIdx, forcedStatus) {
            const materials = [
                { name: '简易款车架-黑', code: 'M-001' },
                { name: '豪华款车架-白', code: 'M-002' },
                { name: '运动款车架-蓝', code: 'M-003' }
            ];
            const mat = zoneId === 0 ? { name: '空挂具', code: 'EMPTY' } : materials[Math.floor(Math.random() * materials.length)];
            
            // Generate random inbound time (within last 30 days)
            const now = new Date();
            const randomDays = Math.floor(Math.random() * 30);
            const randomHours = Math.floor(Math.random() * 24);
            const randomMinutes = Math.floor(Math.random() * 60);
            const randomSeconds = Math.floor(Math.random() * 60);
            const inboundDate = new Date(now.getTime() - (randomDays * 24 * 60 * 60 * 1000));
            inboundDate.setHours(randomHours, randomMinutes, randomSeconds);
            
            const year = inboundDate.getFullYear();
            const month = String(inboundDate.getMonth() + 1).padStart(2, '0');
            const day = String(inboundDate.getDate()).padStart(2, '0');
            const hours = String(inboundDate.getHours()).padStart(2, '0');
            const minutes = String(inboundDate.getMinutes()).padStart(2, '0');
            const seconds = String(inboundDate.getSeconds()).padStart(2, '0');
            const inboundTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            
            return {
                code: `C-${10000 + (zoneId * 1000) + (aisleIdx * 100) + posIdx}`,
                matName: mat.name,
                matCode: mat.code,
                qty: zoneId === 0 ? 0 : 4 + Math.floor(Math.random() * 3), 
                status: forcedStatus,
                inboundTime: inboundTime
            };
        }

        function renderWarehouseMap() {
            const container = document.getElementById('warehouse-map-container');
            container.innerHTML = '';

            zonesConfig.forEach(zone => {
                const zoneDiv = document.createElement('div');
                zoneDiv.className = "bg-slate-50 border border-slate-300 rounded-lg p-4";

                const currentQty = Math.floor(zone.capacity * 0.65);
                const percent = Math.round((currentQty / zone.capacity) * 100);
                
                zoneDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-3 pb-2 border-b border-slate-200">
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-slate-800 text-lg">${zone.name}</span>
                            <span class="text-xs px-2 py-0.5 rounded bg-slate-200 text-slate-600">${zone.aisles} 巷道</span>
                        </div>
                        <div class="flex items-center gap-4 text-sm">
                            <span class="text-slate-500">当前: <span class="font-bold text-slate-800">${currentQty}</span> / ${zone.capacity}</span>
                            <div class="w-32 h-2 bg-slate-200 rounded-full overflow-hidden">
                                <div class="h-full bg-pink-500" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    </div>
                `;

                const aislesContainer = document.createElement('div');
                aislesContainer.className = "space-y-3";

                for (let a = 1; a <= zone.aisles; a++) {
                    const aisleRow = document.createElement('div');
                    aisleRow.className = "flex items-center gap-2";
                    
                    const label = document.createElement('div');
                    label.className = "w-16 flex-shrink-0 text-xs font-bold text-slate-500 uppercase";
                    label.innerText = `巷道 ${a}`;
                    aisleRow.appendChild(label);

                    const track = document.createElement('div');
                    track.className = "aisle-track flex-1 bg-slate-200 h-14 rounded border border-slate-300 flex items-center px-2 gap-2 relative";
                    
                    // Logic for car statuses based on queue position (Left=Head/Out, Right=Tail/In)
                    for (let p = 1; p <= 12; p++) {
                        // 80% chance of occupancy to show gaps
                        if (Math.random() > 0.8) continue; 

                        let status = 'stored';
                        // Force logic: Pos 1 = Outbound, Pos 12 = Inbound, Rest = Stored
                        if (p === 1) status = 'outbound';
                        else if (p === 12) status = 'inbound';
                        
                        const car = getMockCar(zone.id, a, p, status);
                        
                        const carDiv = document.createElement('div');
                        let colorClass = "";
                        // Strict color coding based on status
                        if (status === 'inbound') colorClass = "bg-blue-50 border-blue-500 text-blue-900"; // Queue Tail
                        else if (status === 'outbound') colorClass = "bg-purple-50 border-purple-500 text-purple-900"; // Queue Head
                        else colorClass = "bg-green-50 border-green-500 text-green-900"; // Middle

                        carDiv.className = `flex-shrink-0 w-24 h-10 border rounded cursor-pointer hover:scale-105 transition-transform flex flex-col justify-center px-1.5 shadow-sm text-[10px] leading-tight ${colorClass}`;
                        carDiv.innerHTML = `
                            <div class="flex justify-between font-bold">
                                <span class="truncate w-14">${car.matName}</span>
                                <span>x${car.qty}</span>
                            </div>
                            <div class="text-slate-500 truncate mt-0.5">${car.code}</div>
                        `;

                        carDiv.onclick = (e) => showTooltip(e, car);
                        track.appendChild(carDiv);
                    }
                    aisleRow.appendChild(track);
                    aislesContainer.appendChild(aisleRow);
                }

                zoneDiv.appendChild(aislesContainer);
                container.appendChild(zoneDiv);
            });
        }

        function showTooltip(e, car) {
            e.stopPropagation();
            const tip = document.getElementById('car-tooltip');
            document.getElementById('tip-car-code').innerText = car.code;
            document.getElementById('tip-name').innerText = car.matName;
            document.getElementById('tip-mat-code').innerText = car.matCode;
            document.getElementById('tip-qty').innerText = car.qty;
            document.getElementById('tip-inbound-time').innerText = car.inboundTime || '2026-01-27 10:30:00';
            
            const statusEl = document.getElementById('tip-status');
            if(car.status === 'inbound') { statusEl.innerText = "入库中"; statusEl.className = "text-xs bg-blue-600 px-1.5 py-0.5 rounded"; }
            else if(car.status === 'outbound') { statusEl.innerText = "出库中"; statusEl.className = "text-xs bg-purple-600 px-1.5 py-0.5 rounded"; }
            else { statusEl.innerText = "在库"; statusEl.className = "text-xs bg-green-600 px-1.5 py-0.5 rounded"; }

            const rect = e.currentTarget.getBoundingClientRect();
            tip.style.left = (rect.left + window.scrollX + 20) + 'px';
            tip.style.top = (rect.top + window.scrollY - 10) + 'px';
            tip.classList.remove('hidden');
            requestAnimationFrame(() => {
                tip.classList.add('popover-enter-active');
                tip.style.opacity = '1';
                tip.style.transform = 'scale(1)';
            });
        }

        document.addEventListener('click', () => {
            const tip = document.getElementById('car-tooltip');
            tip.style.opacity = '0';
            tip.style.transform = 'scale(0.95)';
            setTimeout(() => tip.classList.add('hidden'), 200);
        });

        // Auto-render on load
        document.addEventListener("DOMContentLoaded", function() {
            renderWarehouseMap();
        });
    </script>
</body>
</html>